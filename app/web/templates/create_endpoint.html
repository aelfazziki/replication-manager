{% extends "base.html" %}

{% block title %}Create Endpoint - Replication Manager{% endblock %}

{% block content %}
    {# --- Breadcrumb Nav --- #}
    {% if breadcrumbs %}
    <nav aria-label="breadcrumb" class="mt-3">
      <ol class="breadcrumb">
        {% for crumb in breadcrumbs %}
          {% if crumb.url %}
            <li class="breadcrumb-item"><a href="{{ crumb.url }}">{{ crumb.text }}</a></li>
          {% else %}
            <li class="breadcrumb-item active" aria-current="page">{{ crumb.text }}</li>
          {% endif %}
        {% endfor %}
      </ol>
    </nav>
    {% endif %}
    {# --- End Breadcrumb Nav --- #}

    <h2>Create Endpoint</h2>
    <hr>

     {# Display form errors #}
    {% if form.errors %}
    <div class="alert alert-danger">
        <strong>Please correct the errors below:</strong>
        <ul>
            {% for field, errors in form.errors.items() %}
                {% for error in errors %}
                    <li>{{ form[field].label.text if form[field].label else field }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <form id="endpointForm" method="POST" class="needs-validation" novalidate>
        {{ form.hidden_tag() }}

        <div class="card mb-4 shadow-sm">
             <div class="card-header"><i class="bi bi-info-circle"></i> Basic Information</div>
             <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        {{ form.name.label(class="form-label") }}
                        {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else ""), placeholder="e.g., Oracle Prod Source") }}
                         {% if form.name.errors %} <div class="invalid-feedback">{{ form.name.errors[0] }}</div> {% endif %}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.type.label(class="form-label") }}
                        {{ form.type(class="form-select" + (" is-invalid" if form.type.errors else ""), onchange="updateFormFields()") }}
                        {% if form.type.errors %} <div class="invalid-feedback">{{ form.type.errors[0] }}</div> {% endif %}
                    </div>
                     <div class="col-md-4 mb-3">
                        {{ form.endpoint_type.label(class="form-label") }}
                        {{ form.endpoint_type(class="form-select" + (" is-invalid" if form.endpoint_type.errors else ""), onchange="toggleTargetSchema()") }}
                         {% if form.endpoint_type.errors %} <div class="invalid-feedback">{{ form.endpoint_type.errors[0] }}</div> {% endif %}
                    </div>
                </div>
             </div>
        </div>

         <div class="card mb-4 shadow-sm">
             <div class="card-header"><i class="bi bi-person-badge"></i> Credentials</div>
             <div class="card-body">
                 <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.username.label(class="form-label") }}
                        {{ form.username(class="form-control" + (" is-invalid" if form.username.errors else ""), autocomplete="off") }}
                         {% if form.username.errors %} <div class="invalid-feedback">{{ form.username.errors[0] }}</div> {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.password.label(class="form-label") }}
                        {{ form.password(class="form-control" + (" is-invalid" if form.password.errors else ""), type="password") }}
                         {% if form.password.errors %} <div class="invalid-feedback">{{ form.password.errors[0] }}</div> {% endif %}
                    </div>
                </div>
             </div>
         </div>

        {# --- Type-Specific Connection Details --- #}
         <div class="card mb-4 shadow-sm">
             <div class="card-header"><i class="bi bi-hdd-network"></i> Connection Details</div>
             <div class="card-body">
                <div id="postgresFields" class="database-fields">
                    <div class="row">
                         <div class="col-md-4 mb-3">
                             {{ form.postgres_host.label(class="form-label") }}
                             {{ form.postgres_host(class="form-control", placeholder="e.g., localhost or db.example.com") }}
                         </div>
                         <div class="col-md-4 mb-3">
                              {{ form.postgres_port.label(class="form-label") }}
                             {{ form.postgres_port(class="form-control", placeholder="e.g., 5432") }}
                             {% if form.postgres_port.errors %} <div class="invalid-feedback d-block">{{ form.postgres_port.errors[0] }}</div> {% endif %}
                         </div>
                         <div class="col-md-4 mb-3">
                              {{ form.postgres_database.label(class="form-label") }}
                             {{ form.postgres_database(class="form-control", placeholder="e.g., sales_db") }}
                         </div>
                    </div>
                </div>

                <div id="oracleFields" class="database-fields">
                     <div class="row">
                         <div class="col-md-4 mb-3">
                              {{ form.oracle_host.label(class="form-label") }}
                             {{ form.oracle_host(class="form-control", placeholder="e.g., localhost or ora-scan.example.com") }}
                         </div>
                         <div class="col-md-4 mb-3">
                              {{ form.oracle_port.label(class="form-label") }}
                             {{ form.oracle_port(class="form-control", placeholder="e.g., 1521") }}
                             {% if form.oracle_port.errors %} <div class="invalid-feedback d-block">{{ form.oracle_port.errors[0] }}</div> {% endif %}
                         </div>
                         <div class="col-md-4 mb-3">
                              {{ form.oracle_service_name.label(class="form-label") }}
                             {{ form.oracle_service_name(class="form-control", placeholder="e.g., ORCLPDB1") }}
                         </div>
                    </div>
                </div>

                <div id="mysqlFields" class="database-fields">
                    <div class="row">
                         <div class="col-md-4 mb-3">
                             <label for="mysql_host" class="form-label">MySQL Host</label>
                             <input type="text" id="mysql_host" name="mysql_host" class="form-control" placeholder="e.g., localhost">
                         </div>
                          <div class="col-md-4 mb-3">
                             <label for="mysql_port" class="form-label">MySQL Port</label>
                             <input type="number" id="mysql_port" name="mysql_port" class="form-control" placeholder="e.g., 3306">
                             {# Add validation if needed #}
                         </div>
                          <div class="col-md-4 mb-3">
                             <label for="mysql_database" class="form-label">MySQL Database</label>
                             <input type="text" id="mysql_database" name="mysql_database" class="form-control" placeholder="e.g., inventory_db">
                         </div>
                    </div>
                </div>

                <div id="bigqueryFields" class="database-fields">
                     <div class="mb-3">
                         {{ form.dataset.label(class="form-label") }}
                         {{ form.dataset(class="form-control", placeholder="e.g., my_project_id.my_dataset") }}
                     </div>
                     <div class="mb-3">
                         {{ form.credentials_json.label(class="form-label") }}
                         {{ form.credentials_json(class="form-control", rows="5", placeholder="Paste the content of your Google Cloud service account JSON key file here") }}
                          <div class="form-text">Ensure the service account has BigQuery Data Editor and BigQuery User roles.</div>
                     </div>
                </div>
             </div>
        </div>

         {# --- Target Schema (Conditional) --- #}
         <div class="card mb-4 shadow-sm" id="target-schema-group" style="display: none;">
              <div class="card-header"><i class="bi bi-folder-symlink"></i> Target Schema (for Target Endpoints)</div>
              <div class="card-body">
                 <div class="mb-3">
                     {{ form.target_schema.label(class="form-label") }}
                     {{ form.target_schema(class="form-control" + (" is-invalid" if form.target_schema.errors else ""), placeholder="e.g., STAGING or REPLICA") }}
                     {% if form.target_schema.errors %} <div class="invalid-feedback">{{ form.target_schema.errors[0] }}</div> {% endif %}
                     <div class="form-text">Required if 'Create Tables' option is enabled on tasks using this as a destination. Schema must exist or be creatable by the provided user.</div>
                 </div>
              </div>
         </div>


        {# --- Actions --- #}
        <div class="mt-4">
            <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg"></i> Create Endpoint</button>
            <button type="button" class="btn btn-info ms-2" onclick="testConnection()"><i class="bi bi-plug"></i> Test Connection</button>
            <a href="{{ url_for('web.list_endpoints') }}" class="btn btn-secondary ms-2">Cancel</a>
        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}
<script>
function updateFormFields() {
    const type = document.getElementById('type').value;
    // Hide all type-specific field divs
    document.querySelectorAll('.database-fields').forEach(div => {
        div.style.display = 'none';
        // Disable fields within hidden divs so they aren't submitted
        div.querySelectorAll('input, textarea, select').forEach(field => {
            field.disabled = true;
            // Clear values maybe? Optional.
            // if (field.type !== 'hidden') field.value = '';
        });
    });

    // Show the div for the selected type
    const activeFieldsDiv = document.getElementById(type + 'Fields');
    if (activeFieldsDiv) {
        activeFieldsDiv.style.display = 'block';
        // Re-enable fields within the active div
        activeFieldsDiv.querySelectorAll('input, textarea, select').forEach(field => {
            field.disabled = false;
        });
    }
     // Call toggleTargetSchema as well, as endpoint type might affect it
    toggleTargetSchema();
}

function toggleTargetSchema() {
    const endpointTypeField = document.getElementById('endpoint_type');
    const targetSchemaGroup = document.getElementById('target-schema-group');
    const targetSchemaInput = document.getElementById('target_schema');

    if (endpointTypeField.value === 'target') {
        targetSchemaGroup.style.display = 'block';
        targetSchemaInput.disabled = false; // Enable input when shown
    } else {
        targetSchemaGroup.style.display = 'none';
        targetSchemaInput.disabled = true; // Disable input when hidden
        targetSchemaInput.value = ''; // Clear value when hidden
    }
}

// Function to test connection
async function testConnection() {
    const testButton = event.target;
    const originalButtonText = testButton.innerHTML;
    testButton.disabled = true;
    testButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Testing...';

    const form = document.getElementById('endpoint-form'); // Ensure form has id="endpoint-form"

    // --- Manually gather data into a JS object ---
    const dataToSend = {
        // Always include type (read from hidden field in edit, select in create)
        type: form.querySelector('input[name="type"]')
//        type: form.elements['type']?.value || '', // Use hidden field name="type"
        name: form.elements['name']?.value || '',
        endpoint_type: form.elements['endpoint_type']?.value || '', // Include if needed by test logic (currently not)
        username: form.elements['username']?.value || '',
        password: form.elements['password']?.value || '', // Send password for test
        target_schema: form.elements['target_schema']?.value || '',

        // Include all possible type-specific fields
        // Use optional chaining (?.) and nullish coalescing (?? '')
        postgres_host: form.elements['postgres_host']?.value ?? '',
        postgres_port: form.elements['postgres_port']?.value ?? '',
        postgres_database: form.elements['postgres_database']?.value ?? '',
        oracle_host: form.elements['oracle_host']?.value ?? '',
        oracle_port: form.elements['oracle_port']?.value ?? '',
        oracle_service_name: form.elements['oracle_service_name']?.value ?? '',
        mysql_host: form.elements['mysql_host']?.value ?? '',
        mysql_port: form.elements['mysql_port']?.value ?? '',
        mysql_database: form.elements['mysql_database']?.value ?? '',
        dataset: form.elements['dataset']?.value ?? '',
        credentials_json: form.elements['credentials_json']?.value ?? ''
    };
    // --- End gathering data ---

    console.log("--- Data being sent for connection test (JSON): ---");
    // Avoid logging full password in console
    let logData = {...dataToSend};
    if (logData.password) { logData.password = '********'; }
    console.log(logData);
    console.log("--------------------------------------------------");


    try {
        const response = await fetch("{{ url_for('web.test_connection') }}", {
            method: 'POST',
            // *** Set Headers and Body for JSON ***
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
                // Add CSRF token header here if your form uses Flask-WTF CSRF protection
                // 'X-CSRFToken': form.elements['csrf_token']?.value || ''
            },
            body: JSON.stringify(dataToSend) // Send JSON string
            // *** End JSON Headers/Body ***
        });
        const result = await response.json(); // Expect JSON response
        alert(result.success ? '✅ Connection successful!' : '❌ Connection failed: ' + result.message);
    } catch (error) {
        console.error("Connection test error:", error);
        alert('⚠️ Error during connection test: ' + error.message);
    } finally {
         testButton.disabled = false;
         testButton.innerHTML = originalButtonText;
    }
}


// Initialize form fields and target schema visibility on page load
document.addEventListener('DOMContentLoaded', function() {
    updateFormFields(); // Initialize based on default type selection
    toggleTargetSchema(); // Initialize based on default endpoint type selection
});

</script>

<style>
/* Keep database-fields hidden by default */
.database-fields { display: none; }
/* Add other styles if needed */
</style>
{% endblock %}
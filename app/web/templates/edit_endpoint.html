{% extends "base.html" %}

{% block title %}Edit Endpoint - {{ endpoint.name }}{% endblock %}

{% block content %}
    {# --- Breadcrumb Nav --- #}
    {% if breadcrumbs %}
    <nav aria-label="breadcrumb" class="mt-3">
      <ol class="breadcrumb">
        {% for crumb in breadcrumbs %}
          {% if crumb.url %}
            <li class="breadcrumb-item"><a href="{{ crumb.url }}">{{ crumb.text }}</a></li>
          {% else %}
            <li class="breadcrumb-item active" aria-current="page">{{ crumb.text }}</li>
          {% endif %}
        {% endfor %}
      </ol>
    </nav>
    {% endif %}
    {# --- End Breadcrumb Nav --- #}

    <h2>Edit Endpoint: {{ endpoint.name }}</h2>
    <hr>

     {# Display form errors #}
    {% if form.errors %}
    <div class="alert alert-danger">
        <strong>Please correct the errors below:</strong>
        <ul>
             {% for field, errors in form.errors.items() %}
                {% for error in errors %}
                    <li>{{ form[field].label.text if form[field].label else field }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <form method="POST" id="endpoint-form">
        {{ form.hidden_tag() }}
        {# *** ADD THIS HIDDEN FIELD to submit the type since dropdown is disabled *** #}
        <input type="hidden" name="type" value="{{ endpoint.type }}">
        {# *** END ADDED FIELD *** #}

         <div class="card mb-4 shadow-sm">
             <div class="card-header"><i class="bi bi-info-circle"></i> Basic Information</div>
             <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        {{ form.name.label(class="form-label") }}
                        {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else "")) }}
                         {% if form.name.errors %} <div class="invalid-feedback">{{ form.name.errors[0] }}</div> {% endif %}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.type.label(class="form-label") }}
                        {# Disable type change on edit #}
                            {# *** CHANGE: Removed name="type" from disabled select *** #}
                        {{ form.type(class="form-select", disabled=true, id="type") }} {# Keep id if needed #}
                        {# *** END CHANGE *** #}

                        <div class="form-text">Endpoint type cannot be changed after creation.</div>
                    </div>
                     <div class="col-md-4 mb-3">
                        {{ form.endpoint_type.label(class="form-label") }}
                        {{ form.endpoint_type(class="form-select" + (" is-invalid" if form.endpoint_type.errors else ""), onchange="toggleTargetSchema()") }}
                         {% if form.endpoint_type.errors %} <div class="invalid-feedback">{{ form.endpoint_type.errors[0] }}</div> {% endif %}
                    </div>
                </div>
             </div>
        </div>

         <div class="card mb-4 shadow-sm">
             <div class="card-header"><i class="bi bi-person-badge"></i> Credentials</div>
             <div class="card-body">
                 <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.username.label(class="form-label") }}
                        {{ form.username(class="form-control" + (" is-invalid" if form.username.errors else ""), autocomplete="off") }}
                         {% if form.username.errors %} <div class="invalid-feedback">{{ form.username.errors[0] }}</div> {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.password.label(class="form-label") }}
                        {{ form.password(class="form-control", type="password", placeholder="Leave blank to keep current password") }}
                         {% if form.password.errors %} <div class="invalid-feedback">{{ form.password.errors[0] }}</div> {% endif %}
                    </div>
                </div>
             </div>
         </div>

        {# --- Type-Specific Connection Details --- #}
         <div class="card mb-4 shadow-sm">
             <div class="card-header"><i class="bi bi-hdd-network"></i> Connection Details</div>
             <div class="card-body">
                <div id="postgresFields" class="database-fields">
                     <div class="row">
                         <div class="col-md-4 mb-3">
                             {{ form.postgres_host.label(class="form-label") }}
                             {{ form.postgres_host(class="form-control") }}
                         </div>
                         <div class="col-md-4 mb-3">
                              {{ form.postgres_port.label(class="form-label") }}
                             {{ form.postgres_port(class="form-control") }}
                             {% if form.postgres_port.errors %} <div class="invalid-feedback d-block">{{ form.postgres_port.errors[0] }}</div> {% endif %}
                         </div>
                         <div class="col-md-4 mb-3">
                              {{ form.postgres_database.label(class="form-label") }}
                             {{ form.postgres_database(class="form-control") }}
                         </div>
                    </div>
                </div>

                <div id="oracleFields" class="database-fields">
                     <div class="row">
                         <div class="col-md-4 mb-3">
                              {{ form.oracle_host.label(class="form-label") }}
                             {{ form.oracle_host(class="form-control") }}
                         </div>
                         <div class="col-md-4 mb-3">
                              {{ form.oracle_port.label(class="form-label") }}
                             {{ form.oracle_port(class="form-control") }}
                             {% if form.oracle_port.errors %} <div class="invalid-feedback d-block">{{ form.oracle_port.errors[0] }}</div> {% endif %}
                         </div>
                         <div class="col-md-4 mb-3">
                              {{ form.oracle_service_name.label(class="form-label") }}
                             {{ form.oracle_service_name(class="form-control") }}
                         </div>
                    </div>
                </div>

                <div id="mysqlFields" class="database-fields">
                     <div class="row">
                         <div class="col-md-4 mb-3">
                             <label for="mysql_host" class="form-label">MySQL Host</label>
                             <input type="text" id="mysql_host" name="mysql_host" class="form-control" value="{{ endpoint.host if endpoint.type == 'mysql' else '' }}">
                         </div>
                          <div class="col-md-4 mb-3">
                             <label for="mysql_port" class="form-label">MySQL Port</label>
                             <input type="number" id="mysql_port" name="mysql_port" class="form-control" value="{{ endpoint.port if endpoint.type == 'mysql' else '' }}">
                         </div>
                          <div class="col-md-4 mb-3">
                             <label for="mysql_database" class="form-label">MySQL Database</label>
                             <input type="text" id="mysql_database" name="mysql_database" class="form-control" value="{{ endpoint.database if endpoint.type == 'mysql' else '' }}">
                         </div>
                    </div>
                </div>

                <div id="bigqueryFields" class="database-fields">
                    <div class="mb-3">
                         {{ form.dataset.label(class="form-label") }}
                         {{ form.dataset(class="form-control") }}
                     </div>
                     <div class="mb-3">
                         {{ form.credentials_json.label(class="form-label") }}
                         {{ form.credentials_json(class="form-control", rows="5") }}
                     </div>
                </div>
             </div>
        </div>

         {# --- Target Schema (Conditional) --- #}
          <div class="card mb-4 shadow-sm" id="target-schema-group">
              <div class="card-header"><i class="bi bi-folder-symlink"></i> Target Schema (for Target Endpoints)</div>
              <div class="card-body">
                 <div class="mb-3">
                     {{ form.target_schema.label(class="form-label") }}
                     {{ form.target_schema(class="form-control" + (" is-invalid" if form.target_schema.errors else "")) }}
                     {% if form.target_schema.errors %} <div class="invalid-feedback">{{ form.target_schema.errors[0] }}</div> {% endif %}
                     <div class="form-text">Required if 'Create Tables' option is enabled on tasks using this as a destination. Schema must exist or be creatable by the provided user.</div>
                 </div>
              </div>
         </div>

        {# --- Actions --- #}
        <div class="mt-4">
            <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg"></i> Save Changes</button>
             <button type="button" class="btn btn-info ms-2" onclick="testConnection()"><i class="bi bi-plug"></i> Test Connection</button>
            <a href="{{ url_for('web.list_endpoints') }}" class="btn btn-secondary ms-2">Cancel</a>
        </div>
    </form>

{% endblock %}

{% block scripts %}
<script>
// Function to show/hide relevant fields based on TYPE (which is disabled on edit)
function updateFormFields() {
    const type = document.getElementById('type').value; // Get type from disabled field
    // Hide all
    document.querySelectorAll('.database-fields').forEach(div => {
        div.style.display = 'none';
         // Don't disable/enable here as they might be pre-filled
    });
    // Show the correct one
    const activeFieldsDiv = document.getElementById(type + 'Fields');
    if (activeFieldsDiv) {
        activeFieldsDiv.style.display = 'block';
    }
     // Also update target schema visibility
    toggleTargetSchema();
}

// Function to show/hide target schema based on ROLE
function toggleTargetSchema() {
    const endpointTypeField = document.getElementById('endpoint_type');
    const targetSchemaGroup = document.getElementById('target-schema-group');
    const targetSchemaInput = document.getElementById('target_schema');

    if (endpointTypeField.value === 'target') {
        targetSchemaGroup.style.display = 'block';
        targetSchemaInput.disabled = false;
    } else {
        targetSchemaGroup.style.display = 'none';
        targetSchemaInput.disabled = true;
        // Don't clear value on edit page hide
    }
}

// Function to test connection (same as create_endpoint.html)
async function testConnection() {
    const testButton = event.target;
    const originalButtonText = testButton.innerHTML;
    testButton.disabled = true;
    testButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Testing...';

    const form = document.getElementById('endpoint-form'); // Ensure form has id="endpoint-form"

    // --- Manually gather data into a JS object ---
    const dataToSend = {
        // Always include type (read from hidden field in edit, select in create)
//        type: form.querySelector('input[name="type"]'),
//        name: form.querySelector('input[name="name"]'),
//        endpoint_type: form.querySelector('input[name="endpoint_type"]'),
//        username: form.querySelector('input[name="username"]'),
//        password: form.querySelector('input[name="password"]'),
//        target_schema: form.querySelector('input[name="target_schema"]'),
        type: form.elements['type']?.value || 'oracle', // Use hidden field name="type"
        name: form.elements['name']?.value || '',
        endpoint_type: form.elements['endpoint_type']?.value || '', // Include if needed by test logic (currently not)
        username: form.elements['username']?.value || '',
        password: form.elements['password']?.value || '', // Send password for test
        target_schema: form.elements['target_schema']?.value || '',

        // Include all possible type-specific fields
        // Use optional chaining (?.) and nullish coalescing (?? '')
        postgres_host: form.elements['postgres_host']?.value ?? '',
        postgres_port: form.elements['postgres_port']?.value ?? '',
        postgres_database: form.elements['postgres_database']?.value ?? '',
        oracle_host: form.elements['oracle_host']?.value ?? '',
        oracle_port: form.elements['oracle_port']?.value ?? '',
        oracle_service_name: form.elements['oracle_service_name']?.value ?? '',
        mysql_host: form.elements['mysql_host']?.value ?? '',
        mysql_port: form.elements['mysql_port']?.value ?? '',
        mysql_database: form.elements['mysql_database']?.value ?? '',
        dataset: form.elements['dataset']?.value ?? '',
        credentials_json: form.elements['credentials_json']?.value ?? ''
    };
    // --- End gathering data ---

    console.log("--- Data being sent for connection test (JSON): ---");
    // Avoid logging full password in console
    let logData = {...dataToSend};
    if (logData.password) { logData.password = '********'; }
    console.log(logData);
    console.log("--------------------------------------------------");


    try {
        const response = await fetch("{{ url_for('web.test_connection') }}", {
            method: 'POST',
            // *** Set Headers and Body for JSON ***
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
                // Add CSRF token header here if your form uses Flask-WTF CSRF protection
                // 'X-CSRFToken': form.elements['csrf_token']?.value || ''
            },
            body: JSON.stringify(dataToSend) // Send JSON string
            // *** End JSON Headers/Body ***
        });
        const result = await response.json(); // Expect JSON response
        alert(result.success ? '✅ Connection successful!' : '❌ Connection failed: ' + result.message);
    } catch (error) {
        console.error("Connection test error:", error);
        alert('⚠️ Error during connection test: ' + error.message);
    } finally {
         testButton.disabled = false;
         testButton.innerHTML = originalButtonText;
    }
}


// Initialize fields on page load
document.addEventListener('DOMContentLoaded', function() {
    updateFormFields(); // Show fields for the endpoint's type
});

</script>

<style>
.database-fields { display: none; }
/* Add other styles if needed */
</style>
{% endblock %}
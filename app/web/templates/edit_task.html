{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>Edit Replication Task</h2>
    <form method="POST" id="task-form">
        {{ form.hidden_tag() }}

        <input type="hidden" name="selected-tables" id="selected-tables"
               value="{{ tables_json_val | default('[]') | forceescape }}">

        <div class="card mb-4">
            <div class="card-header"><i class="bi bi-pencil-square"></i> Task Details</div>
            <div class="card-body">
                <div class="mb-3">
                    {{ form.name.label(class="form-label") }}
                    {{ form.name(class="form-control", autocomplete="off") }}
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white"><i class="bi bi-database"></i> Source Endpoint</div>
                    <div class="card-body">
                        {{ form.source.label(class="form-label") }}
                        {{ form.source(class="form-select", autocomplete="off") }}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-success text-white"><i class="bi bi-box-arrow-right"></i> Destination Endpoint</div>
                    <div class="card-body">
                        {{ form.destination.label(class="form-label") }}
                        {{ form.destination(class="form-select", autocomplete="off") }}
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-table"></i> Table Selection
                <span class="badge bg-secondary ms-2" id="selected-count">0</span>
                <div class="float-end">
                    <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="document.getElementById('source').dispatchEvent(new Event('change'))" title="Refresh Tables">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="input-group input-group-sm mb-2">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" id="schema-search" class="form-control" placeholder="Filter schemas/tables..." onkeyup="filterSchemas()">
                        </div>
                        <div id="schema-list" class="border rounded p-2" style="max-height: 400px; overflow-y: auto;">
                            <p class="text-muted">Select a source endpoint to see tables.</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                         <div class="input-group input-group-sm mb-2">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" id="selected-search" class="form-control" placeholder="Filter selected tables..." onkeyup="filterSelected()">
                        </div>
                        <div id="selected-list" class="border rounded p-2 bg-light" style="max-height: 400px; overflow-y: auto;">
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header"><i class="bi bi-gear"></i> Options</div>
            <div class="card-body">
                <div class="form-check form-switch mb-2">
                    {{ form.initial_load(class="form-check-input") }}
                    {{ form.initial_load.label(class="form-check-label") }}
                </div>
                 <div class="form-check form-switch">
                    {{ form.create_tables(class="form-check-input") }}
                    {{ form.create_tables.label(class="form-check-label") }}
                </div>
                </div>
        </div>

        <div class="text-end mb-4">
             {{ form.submit(class="btn btn-primary") }}
             <a href="{{ url_for('web.dashboard') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
    // Use an array to store selected table objects {schema: '...', table: '...'}
    let selectedTables = [];

    async function fetchSchemasAndTables(endpointId) {
        if (!endpointId) {
            document.getElementById('schema-list').innerHTML = '<p class="text-muted">Select a source endpoint to see tables.</p>';
            return;
        }
        console.log(`Workspaceing tables for endpoint ID: ${endpointId}`);
        document.getElementById('schema-list').innerHTML = '<p class="text-info">Loading tables...</p>';
        try {
            const response = await fetch(`/api/endpoints/${endpointId}/tables`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }
            const tablesData = await response.json();

            const schemas = {};
            tablesData.forEach(item => {
                if (!schemas[item.schema]) schemas[item.schema] = [];
                schemas[item.schema].push(item.table);
            });

            let html = '';
            Object.keys(schemas).sort().forEach(schema => {
                html += `
                <div class="card mb-2 schema-card">
                    <div class="card-header bg-light p-1 ps-2" style="cursor: pointer;" onclick="toggleSchema('${schema}-tables', this)">
                        <strong class="text-primary schema-name">${schema}</strong> <small class="text-muted">(${schemas[schema].length})</small>
                        <i class="bi bi-chevron-down float-end"></i>
                    </div>
                    <div id="${schema}-tables" class="list-group list-group-flush schema-tables" style="display: none;">`;
                schemas[schema].sort().forEach(table => {
                    const isSelected = selectedTables.some(t => t.schema === schema && t.table === table);
                    const uniqueId = `chk-${schema}-${table}`.replace(/[^a-zA-Z0-9-_]/g, '_');
                    html += `
                        <label class="list-group-item list-group-item-action py-1 table-item" for="${uniqueId}">
                            <input class="form-check-input me-2" type="checkbox" value="${schema}.${table}"
                                   id="${uniqueId}" ${isSelected ? 'checked' : ''}
                                   onchange="handleTableSelection(this, '${schema}', '${table}')">
                            <span class="table-name">${table}</span>
                        </label>`;
                });
                html += `</div></div>`;
            });
            document.getElementById('schema-list').innerHTML = html || '<p class="text-muted">No tables found for this endpoint.</p>';

        } catch (error) {
            console.error('Error fetching tables:', error);
            document.getElementById('schema-list').innerHTML = `<p class="text-danger">Error loading tables: ${error.message}</p>`;
        }
    }

    function handleTableSelection(checkbox, schema, table) {
        if (checkbox.checked) {
            addTable(schema, table);
        } else {
            removeTable(schema, table);
        }
    }

    function addTable(schema, table) {
        if (!selectedTables.some(t => t.schema === schema && t.table === table)) {
            selectedTables.push({ schema: schema, table: table });
            console.log('Added:', { schema: schema, table: table }, ' Current:', selectedTables);
            refreshSelectedList();
            updateHiddenField();
        }
    }

    function removeTable(schema, table) {
        selectedTables = selectedTables.filter(t => !(t.schema === schema && t.table === table));
        console.log('Removed:', { schema: schema, table: table }, ' Current:', selectedTables);
        const uniqueId = `chk-${schema}-${table}`.replace(/[^a-zA-Z0-9-_]/g, '_');
        const checkbox = document.getElementById(uniqueId);
        if (checkbox) checkbox.checked = false;
        refreshSelectedList();
        updateHiddenField();
    }

    function refreshSelectedList() {
        const listElement = document.getElementById('selected-list');
        if (!listElement) return;
        listElement.innerHTML = '';
        selectedTables.sort((a, b) => {
           if (a.schema !== b.schema) return a.schema.localeCompare(b.schema);
           return a.table.localeCompare(b.table);
        }).forEach(tableObj => {
            const item = document.createElement('div');
            item.className = 'selected-item d-flex justify-content-between align-items-center p-1 border-bottom';
            item.innerHTML = `
                <span title="${tableObj.schema}.${tableObj.table}"><i class="bi bi-table text-muted me-1"></i>${tableObj.schema}.${tableObj.table}</span>
                <button type="button" class="btn btn-sm btn-outline-danger py-0 px-1" title="Remove"
                        onclick="removeTable('${tableObj.schema}', '${tableObj.table}')">
                    <i class="bi bi-x-lg"></i>
                </button>
            `;
            listElement.appendChild(item);
        });
        const countBadge = document.getElementById('selected-count');
        if(countBadge) countBadge.textContent = selectedTables.length;
    }

    function updateHiddenField() {
        const hiddenInput = document.getElementById('selected-tables');
        if (hiddenInput) {
            hiddenInput.value = JSON.stringify(selectedTables); // Stringify array of objects
            console.log('Updated hidden field:', hiddenInput.value);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const sourceSelect = document.getElementById('source');
        const selectedTablesInput = document.getElementById('selected-tables');

        // --- Correct Initialization for edit_task.html ---
        if (selectedTablesInput && selectedTablesInput.value && selectedTablesInput.value !== '[]') {
            try {
                // Parse the JSON string from the hidden input's initial value
                const initialTables = JSON.parse(selectedTablesInput.value);
                // Ensure it's an array of objects before assigning
                if (Array.isArray(initialTables) && initialTables.every(item => typeof item === 'object' && item !== null && 'schema' in item && 'table' in item)) {
                     selectedTables = initialTables;
                     console.log('Initialized selectedTables from hidden field:', selectedTables);
                } else {
                     console.error('Initial value in selected-tables is not a valid array of table objects:', selectedTablesInput.value);
                     selectedTablesInput.value = '[]'; // Reset if invalid format found
                }
            } catch (e) {
                console.error("Error parsing initial selected tables JSON:", e);
                selectedTablesInput.value = '[]'; // Reset if invalid JSON
            }
        }
        // --- End Initialization ---

        refreshSelectedList(); // Initial display of selected list

        if (sourceSelect) {
            sourceSelect.addEventListener('change', function() {
                fetchSchemasAndTables(this.value);
            });
            if (sourceSelect.value) {
                fetchSchemasAndTables(sourceSelect.value); // Trigger fetch on load if source selected
            } else {
                 document.getElementById('schema-list').innerHTML = '<p class="text-muted">Select a source endpoint to see tables.</p>';
            }
        }
    });

    function toggleSchema(divId, headerElement) {
        const tablesDiv = document.getElementById(divId);
        const icon = headerElement.querySelector('i.bi');
        const isVisible = tablesDiv.style.display === 'block';
        tablesDiv.style.display = isVisible ? 'none' : 'block';
        icon.className = isVisible ? 'bi bi-chevron-down float-end' : 'bi bi-chevron-up float-end';
    }

     function filterSchemas() {
        const search = document.getElementById('schema-search').value.toLowerCase();
        document.querySelectorAll('#schema-list .schema-card').forEach(card => {
            const schemaName = card.querySelector('.schema-name').textContent.toLowerCase();
            const tables = Array.from(card.querySelectorAll('.table-name')).map(t => t.textContent.toLowerCase());
            const matches = schemaName.includes(search) || tables.some(t => t.includes(search));
            card.style.display = matches ? '' : 'none';
        });
    }

    function filterSelected() {
        const search = document.getElementById('selected-search').value.toLowerCase();
        document.querySelectorAll('#selected-list .selected-item').forEach(item => {
            const fullTableName = item.querySelector('span').textContent.toLowerCase();
            item.style.display = fullTableName.includes(search) ? '' : 'flex'; // Use flex for d-flex
        });
    }
</script>

<style>
    /* Add styles if needed, keep existing styles */
    .schema-tables { max-height: 400px; overflow-y: auto; }
    .table-item, .selected-item { transition: background-color 0.2s; }
    .table-item:hover, .selected-item:hover { background-color: #f8f9fa; }
    .selected-item span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
</style>
{% endblock %}